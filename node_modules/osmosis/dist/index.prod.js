"use strict";function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _Command=_interopRequireWildcard(require("../lib/Command.js")),_Queue=_interopRequireDefault(require("../lib/Queue.js")),_Request=_interopRequireDefault(require("../lib/Request.js")),_libxmljsDom=_interopRequireWildcard(require("libxmljs-dom"));function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _getRequireWildcardCache(){if("function"!=typeof WeakMap)return null;var e=new WeakMap;return _getRequireWildcardCache=function(){return e},e}function _interopRequireWildcard(e){if(e&&e.__esModule)return e;if(null===e||"object"!==_typeof(e)&&"function"!=typeof e)return{default:e};var t=_getRequireWildcardCache();if(t&&t.has(e))return t.get(e);var o={},s=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var r in e)if(Object.prototype.hasOwnProperty.call(e,r)){var i=s?Object.getOwnPropertyDescriptor(e,r):null;i&&(i.get||i.set)?Object.defineProperty(o,r,i):o[r]=e[r]}return o.default=e,t&&t.set(e,o),o}var instanceId=0,memoryUsage=0,cachedSelectors={},toMB=function(e,t){return(e/1024/1024).toFixed(t||2)+"Mb"},extend=function(e,t){for(var o,s=Object.keys(t),r=s.length;r--;)e[o=s[r]]=t[o];return e};function Osmosis(e,t){if(void 0!==e)return this instanceof Osmosis?new Osmosis.get(e,t):Osmosis.get(e,t);this.queue=new _Queue.default(this),this.command=new _Command.default(this),this.id=++instanceId}Osmosis.prototype.opts={accept:"text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8",compressed:!0,concurrency:5,decode_response:!0,follow:3,follow_set_cookies:!0,follow_set_referer:!0,keep_data:!1,parse_cookies:!0,parse_response:!1,rejectUnauthorized:!1,statsThreshold:25,timeout:3e4,tries:3,user_agent:"Mozilla/5.0 (Windows NT x.y; rv:10.0) Gecko/20100101 Firefox/10.0"},Osmosis.config=Osmosis.prototype.config=function(e,t){var o,s;if(o=!0==(void 0!==this.prototype)?this.prototype.opts:void 0===this.opts?this.opts={}:this.opts,void 0===e)return o;if(void 0!==t)o[e]=t;else if(void 0!==s)for(s in e)o[s]=e[s]},Osmosis.prototype.run=function(){var e=this;process.nextTick(function(){e.started=!0,e.command.start()})},Osmosis.prototype.request=function(r,i,u,n){var p=this,t=r.href;r.method,r.params;this.requests++,this.queue.requests++,this.queue.push(),"function"==typeof i.user_agent&&(i.user_agent=i.user_agent()),(0,_Request.default)(r.method,r,r.params,i,n,function(e,t,o){var s=i.proxies;p.queue.requests--,void 0!==t&&404===t.statusCode||void 0===s||(p.command.error("proxy "+(s.index+1)+"/"+s.length+" failed ("+i.proxy+")"),1<s.length&&(i.proxies.splice(s.index,1),i.proxy=s[s.index])),null!==e&&++n<i.tries?(p.queueRequest(r,i,u,n),!0===p.opts.log&&p.command.error(e+", retrying "+r.href+" ("+(n+1)+"/"+i.tries+")")):u(e,t,o),p.dequeueRequest(),p.queue.pop()}).on("redirect",function(e){!0===p.opts.log&&p.command.log("[redirect] "+t+" -> "+e)})},Osmosis.prototype.queueRequest=function(e,t,o,s){void 0===s&&(s=0),this.queue.requests<this.opts.concurrency?this.request(e,t,o,s):this.queue.enqueue([e,t,o,s])},Osmosis.prototype.dequeueRequest=function(){var e;0===this.queue.length||this.queue.requests>=this.opts.concurrency||(e=this.queue.dequeue(),this.request(e[0],e[1],e[2],e[3]))},Osmosis.prototype.parse=function(e,t){var o=(0,_libxmljsDom.parseHtml)(e,t);return void 0!==t&&void 0!==t.baseUrl&&(o.location=t.baseUrl),o},Osmosis.prototype.resources=function(){var e=process.memoryUsage(),t=toMB(e.rss-memoryUsage),o=(0,_libxmljsDom.memoryUsage)(),s=(0,_libxmljsDom.nodeCount)();!0===this.opts.debug?(1e3<=s&&(s=(s/1e3).toFixed(0)+"k"),"-"!==t.charAt(0)&&(t="+"+t),this.command.debug("stack: "+this.queue.count+", requests: "+this.requests+" ("+this.queue.requests+" queued), RAM: "+toMB(e.rss)+" ("+t+"), libxml: "+(o/e.rss*100).toFixed(1)+"% ("+s+" nodes), heap: "+(e.heapUsed/e.heapTotal*100).toFixed(0)+"% of "+toMB(e.heapTotal)),memoryUsage=e.rss):this.resources=null},Osmosis.prototype.setParent=function(e){this.parent=e,this.queue=e.instance.queue,this.opts=e.instance.opts},Osmosis.prototype.resume=function(e){var t,o;if("function"==typeof e)void 0===this.resumeQueue&&(this.resumeQueue=[]),this.resumeQueue.push(e);else{for(t=this.resumeQueue.length,o=0;o<t;++o)this.resumeQueue[o]();this.dequeueRequest()}},Osmosis.prototype.requests=0,Osmosis.prototype.paused=!1,Osmosis.prototype.stopped=!1,Osmosis.prototype.inspect=function(){return"Osmosis:"+this.id},Object.keys(_Command.prototype).forEach(function(u){void 0===Osmosis[u]&&(Osmosis[u]=function e(t,o,s){var r=new Osmosis,i=r.command;return r.calledWithNew=this instanceof e,i[u](t,o,s)})}),_libxmljsDom.Document.prototype.findXPath=_libxmljsDom.Document.prototype.find,_libxmljsDom.Element.prototype.findXPath=_libxmljsDom.Element.prototype.find,_libxmljsDom.Document.prototype.find=function(e,t){return this.root().find(e,t)},_libxmljsDom.Element.prototype.find=function(e){return"/"===e.charAt(1)||"/"===e.charAt(0)||"("===e.charAt(0)?this.findXPath(e):(void 0===cachedSelectors[e]&&(cachedSelectors[e]=(0,_libxmljsDom.css2xpath)(e)),this.findXPath(cachedSelectors[e])||[])},Osmosis.libxmljs=_libxmljsDom.default;var _default=Osmosis;exports.default=_default;